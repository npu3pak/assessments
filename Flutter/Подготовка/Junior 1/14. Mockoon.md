# Лекция 14: Mockoon — инструмент для тестирования API в Flutter-приложениях  

## 1. Зачем нужен Mockoon?  
Mockoon — это **локальный инструмент для создания и управления заглушками (mock-серверами)**, который позволяет разработчикам тестировать логику приложений без необходимости подключения к реальному серверу или ожидания реализации бэкенд-компонентов. Это особенно полезно в следующих сценариях:  

### Ключевые преимущества Mockoon:
1. **Симуляция API-ответов**: Можно создать эндпоинты, которые возвращают фиктивные данные (например, JSON), чтобы протестировать отображение информации в Flutter-приложении.  
2. **Изоляция от бэкенда**: Разработчик может тестировать логику приложения даже если бэкенд ещё не готов или недоступен.  
3. **Быстрая настройка**: Интерфейс Mockoon позволяет создавать и редактировать заглушки за секунды без написания кода.  
4. **Поддержка сложных сценариев**: Возможность настроить ответы, зависимости от параметров запроса, таймауты, ошибки и т.д.  

### Пример использования в Flutter:  
Представьте, что вы разрабатываете приложение для работы с API погоды (`GET /api/weather`). Однако бэкенд ещё не готов. С помощью Mockoon можно создать заглушку, которая будет возвращать фиктивные данные о погоде (например, `{ "temperature": 25, "city": "Moscow" }`), чтобы вы могли протестировать отображение информации в UI Flutter-приложения.  

---

## 2. Как запустить Mockoon в режиме прокси-сервера  
Mockoon можно запускать в нескольких режимах: **локальный сервер**, **прокси-сервер** и **база данных** (для хранения эндпоинтов). В этой лекции рассмотрим **режим прокси-сервера**, который позволяет перенаправлять запросы из Flutter-приложения в Mockoon.  

### Шаги для запуска:
1. **Установите Mockoon** (если ещё не установлено):  
   - Через npm:  
     ```bash
     npm install -g mockoon-cli
     ```
   - Или скачайте бинарник с официального сайта: [https://mockoon.com](https://mockoon.com).  

2. **Запустите Mockoon в режиме прокси-сервера**:  
   - В терминале выполните команду:  
     ```bash
     mockoon run --proxy --port 3000
     ```
     Здесь `--proxy` указывает, что Mockoon будет работать как прокси-сервер. Порт `3000` можно выбрать любой свободный (например, 8080).  

3. **Откройте веб-интерфейс**:  
   После запуска откроется браузер с URL `http://localhost:3000`, где вы увидите интерфейс Mockoon.  

### Настройка прокси:
В режиме прокси Mockoon перенаправляет запросы, отправленные в реальный API (например, `https://api.example.com/`), в локальную заглушку. Для этого необходимо указать **прокси-настройки** в Mockoon:  
1. В интерфейсе Mockoon нажмите кнопку **"Add proxy server"**.  
2. Укажите адрес реального сервера (например, `https://api.example.com`).  
3. Mockoon перенаправит все запросы к этому URL в вашу локальную заглушку.  

---

## 3. Как отправлять запросы в Mockoon из эмулятора Android  
Чтобы Flutter-приложение могло взаимодействовать с Mockoon, нужно настроить эмулятор Android так, чтобы он перенаправлял трафик на локальный сервер (Mockoon).  

### Шаги:
1. **Установите IP адрес эмулятора**:  
   В Flutter приложении используйте `http://localhost:3000` для отправки запросов в Mockoon. Однако, если вы используете эмулятор Android, то `localhost` может не сработать (потому что он ссылается на сам эмулятор, а не на хост-машину).  

2. **Настройте перенаправление порта**:  
   - В Android Studio откройте **AVD Manager** и выберите ваш эмулятор.  
   - Нажмите **Edit...**, затем в разделе **Emulated Performance → Networking** установите:  
     - `Use Host GPU` — выключить (если не нужно).  
     - В поле **IP address** укажите `127.0.0.1`, а порт — тот же, что указан в Mockoon (например, 3000).  

   Или, если это не сработает, выполните команду в терминале:  
   ```bash
   adb reverse tcp:8080 tcp:3000
   ```
   Эта команда перенаправит запросы на порт `8080` эмулятора на локальный порт `3000`.  

3. **Пример кода в Flutter**:  
   ```dart
   import 'package:http/http.dart' as http;

   Future<void> fetchWeather() async {
     final response = await http.get(Uri.parse('http://127.0.0.1:8080/api/weather'));
     print(response.body);
   }
   ```
   Здесь `http://127.0.0.1:8080` — это эмулятор, который перенаправляет запрос на локальный Mockoon.  

---

## 4. Как посмотреть логи в Mockoon  
В режиме прокси-сервера Mockoon сохраняет **все входящие и исходящие запросы** в интерфейсе. Это позволяет отслеживать, какие эндпоинты были вызваны, с какими параметрами, и что вернуло сервер.  

### Шаги:
1. Откройте Mockoon в браузере (http://localhost:3000).  
2. Перейдите на вкладку **"Logs"**.  
3. Здесь вы увидите подробную информацию:  
   - URL запроса,  
   - Метод (GET/POST),  
   - Параметры и тело запроса,  
   - Время выполнения,  
   - Ответ сервера (включая статус коды).  

### Пример лога:
```json
{
  "timestamp": "2024-05-15T10:30:45.123Z",
  "method": "GET",
  "url": "http://127.0.0.1:8080/api/weather",
  "responseStatus": 200,
  "responseBody": "{\"temperature\":25,\"city\":\"Moscow\"}"
}
```

---

## 5. Как переопределить запросы сервера  
Mockoon позволяет **переопределять ответы реального сервера**. Это полезно, когда вы хотите тестировать разные сценарии (например, ошибки, логины, отсутствие данных).  

### Шаги:
1. В интерфейсе Mockoon создайте коллекцию (например, "Weather API").  
2. Добавьте эндпоинт:  
   - **URL**: `/api/weather`  
   - **Метод**: `GET`  
   - **Response body** (вручную):  
     ```json
     {
       "temperature": 30,
       "city": "London"
     }
     ```
3. Сохраните коллекцию и запустите её.  

### Как это работает:  
Когда Flutter-приложение отправляет запрос на `http://127.0.0.1:8080/api/weather`, Mockoon возвращает фиктивный ответ с `temperature=30` вместо реального значения. Это позволяет протестировать логику приложения без зависимости от бэкенда.  

---

## 6. Как сделать несколько заглушек для одного запроса и переключаться между ними  
Mockoon поддерживает **множественные сценарии ответов** для одного эндпоинта. Это полезно, когда нужно тестиовать разные ситуации (например, успешный запрос vs ошибка 404).  

### Шаги:
1. В интерфейсе Mockoon откройте коллекцию и выберите нужный эндпоинт (`/api/weather`).  
2. Перейдите на вкладку **"Responses"**.  
3. Добавьте несколько вариантов ответов:  
   - **Вариант 1**: `Status code`: 200, `Body`: `{ "temperature": 25 }`  
   - **Вариант 2**: `Status code`: 404, `Body`: `{ "error": "Not found" }`  

4. Переключение между ответами:  
   - В интерфейсе Mockoon можно выбрать нужный сценарий в выпадающем списке **"Response"**.  

### Пример использования в Flutter:  
```dart
Future<void> fetchWeather() async {
  final response = await http.get(Uri.parse('http://127.0.0.1:8080/api/weather'));
  if (response.statusCode == 200) {
    print("Успех: ${response.body}");
  } else {
    print("Ошибка: ${response.body}"); // Выведет "Not found"
  }
}
```

---

## 7. Как указать таймаут обработки запросов  
Mockoon позволяет настраивать **время ожидания** для каждого эндпоинта, чтобы имитировать задержку сервера. Это полезно для тестирования поведения приложения в случае медленного ответа от сервера.  

### Шаги:
1. В интерфейсе Mockoon откройте коллекцию и выберите нужный эндпоинт.  
2. Перейдите на вкладку **"Settings"**.  
3. Найдите поле **"Response delay"** (время задержки).  
4. Укажите значение, например: `2000` мс (2 секунды).  

### Пример:  
Когда Flutter-приложение отправляет запрос на `/api/weather`, Mockoon будет ждать 2 секунды, а затем вернуть ответ. Это помогает протестировать, как приложение ведёт себя при длительной загрузке данных.  

---

## Практическое задание  
1. Установите Mockoon и запустите его в режиме прокси-сервера.  
2. Создайте коллекцию с эндпоинтом `/api/user` методом `GET`, который возвращает JSON:  
   ```json
   {
     "name": "John Doe",
     "email": "john@example.com"
   }
   ```
3. Настройте эмулятор Android для отправки запросов на `http://127.0.0.1:8080/api/user`.  
4. Напишите Flutter-приложение с кнопкой, которая отправляет GET-запрос и отображает результат.  
5. В Mockoon добавьте ещё один ответ для `/api/user` (например, `error: "User not found"`). Тестируйте переключение между вариантами.  

---

## Контрольные вопросы по теме  
1. Зачем нужен Mockoon в разработке Flutter-приложений?  
2. Как запустить Mockoon в режиме прокси-сервера через терминал?  
3. Чем отличается локальный сервер Mockoon от режима прокси?  
4. Как настроить эмулятор Android для отправки запросов в Mockoon?  
5. Где можно посмотреть логи в Mockoon?  
6. Как переопределить ответы реального сервера в Mockoon?  
7. Можно ли создать несколько вариантов ответа для одного эндпоинта и как это сделать?  
8. Как указать таймаут обработки запросов в Mockoon?  

---

## Список литературы и ссылок для дополнительного чтения  
1. **Официальный сайт Mockoon**: [https://mockoon.com](https://mockoon.com)  
2. **Документация по API Mockoon**: [https://docs.mockoon.com](https://docs.mockoon.com)  
3. **Flutter-примеры с Mockoon**: GitHub-репозитории, например: [https://github.com/mockoon/flutter-example](https://github.com/mockoon/flutter-example)  
4. **Статья о тестировании API в Flutter**: [https://medium.com/@example/testing-api-with-mockoon-in-flutter](https://medium.com/@example/testing-api-with-mockoon-in-flutter)  
5. **Книга "Flutter in Action"** — глава 10: Тестирование API с помощью инструментов (включает Mockoon).  

--- 

Эта лекция полностью охватывает тему Mockoon для разработчиков Flutter на уровне Junior, с подробными примерами и практическими задачами. Вы можете использовать её как самостоятельный учебный материал.