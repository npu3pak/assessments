# **Лекция 13: Flutter. Поддерживаемые архитектуры процессоров**

## **1. Что такое архитектура процессора?**

**Архитектура процессора (processor architecture)** — это набор команд, структура регистров, режимы работы и другие технические характеристики, которые определяют, как процессор взаимодействует с программным обеспечением. Она описывает, как данные обрабатываются, какие инструкции понимает процессор и как он работает с памятью.

### **Основные типы архитектур процессоров**
1. **ARM (Advanced RISC Machine)** — RISC-архитектура, которая широко используется в мобильных устройствах. ARM делится на версии: v7, v8 (64-битная), и т.д.
2. **x86** — CISC-архитектура, используемая преимущественно в ПК и серверах. Часто встречается в Android-устройствах с Windows 10/11 или emulator-ах для разработки.
3. **MIPS (Microprocessor without Interlocked Pipeline Stages)** — устаревшая архитектура, которая использовалась в некоторых старых устройствах (например, Nexus One).
4. **PowerPC** — редко используется в современных устройствах.

### **Зачем знать архитектуры процессоров разработчику?**
- При сборке приложений важно убедиться, что библиотеки и код поддерживают нужные архитектуры.
- Ошибки могут возникнуть, если, например, вы попытаетесь запустить APK с кодом для x86 на устройстве с ARM v7.
- Понимание архитектур позволяет оптимизировать приложение под конкретные устройства.

---

## **2. Какие архитектуры процессоров поддерживаются Flutter?**

Flutter — кроссплатформенная фреймворк, который использует Dart VM и компилирует код в нативный (на уровне C++) для Android и iOS через поддержку FFI (Foreign Function Interface) и platform channels. Это позволяет Flutter работать на различных архитектурах.

### **Поддерживаемые архитектуры в Flutter (Android)**

1. **ARMv7** — 32-битная архитектура, широко используемая на старых Android-устройствах.
2. **ARM64 (ARMv8)** — 64-битная версия ARM, которая сейчас стандартна для большинства современных смартфонов.
3. **x86** — поддерживается через emulator и в некоторых устройствах с Windows 10/11.
4. **MIPS** — редко используется, но Flutter может собрать код для этой архитектуры (требует дополнительной настройки).

> **Примечание:** Для iOS поддерживаются только ARM64 (на устройствах с Apple Silicon) и x86_64 (для эмуляторов).

### **Почему Flutter поддерживает эти архитектуры?**

- Flutter использует Dart VM, который компилируется в нативный код для каждой из указанных архитектур.
- Для Android используется инструментарий Gradle, который позволяет собирать APK с поддержкой нескольких архитектур.

---

## **3. Указание поддерживаемых архитектур при сборке Android-приложений**

Flutter использует Flutter SDK и инструменты Android Studio (Gradle) для сборки APK, который должен быть совместим с выбранными архитектурами.

### **3.1. Настройка Gradle для поддержки нужных архитектур**

Файл `build.gradle` в проекте Flutter содержит настройки, которые определяют, какие архитектуры поддерживаются при сборке APK.

Пример конфигурации:
```gradle
android {
    namespace 'com.example.myapp'
    compileSdk 33

    defaultConfig {
        applicationId "com.example.myapp"
        minSdk 21
        targetSdk 33
        versionCode 1
        versionName "1.0"

        // Указание поддерживаемых архитектур
        ndk {
            abiFilters 'armeabi-v7a', 'arm64-v8a', 'x86_64'
        }
    }

    buildTypes {
        release {
            minifyEnabled false
            useProguard false
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }
    }
}
```

> **Объяснение:**
- `ndk { abiFilters ... }` — указывает, какие архитектуры будут включены в APK.
- `'armeabi-v7a'` — ARMv7 (32-бит).
- `'arm64-v8a'` — ARM64 (64-бит).
- `'x86_64'` — x86 (для эмуляторов и редких устройств).

---

### **3.2. Сборка APK с указанием архитектур**

Команда Flutter для сборки APK:
```bash
flutter build apk --target-platform android-armv7
```

Если нужно собрать APK для нескольких архитектур, можно использовать:
```bash
flutter build apk --target-platform android-arm64 --target-platform android-x86_64
```

> **Примечание:** Для Flutter 2.10+ поддерживается сборка APK с несколькими архитектурами в одном файле через `--split-per-abi`, если требуется.

---

### **3.3. Проверка поддержки архитектур в APK**

После сборки можно проверить, какие архитектуры поддерживаются в APK:
```bash
unzip build/app/outputs/apk/release/app-release.apk -d apk_content
ls apk_content/lib/
```

В папке `lib` должны быть подпапки для каждой из указанных архитектур (например, `lib/arm64-v8a`, `lib/x86_64`).

---

## **Практическое задание**

### **Цель:** Настроить сборку Flutter-приложения с поддержкой ARM64 и x86_64.

**Шаги:**
1. Создайте новый проект Flutter:
   ```bash
   flutter create multi_abi_app
   cd multi_abi_app
   ```
2. Откройте `android/app/build.gradle` и измените раздел `ndk { abiFilters ... }`, добавив поддержку ARM64 и x86_64:
   ```gradle
   ndk {
       abiFilters 'arm64-v8a', 'x86_64'
   }
   ```
3. Соберите APK:
   ```bash
   flutter build apk --target-platform android-arm64 --target-platform android-x86_64
   ```
4. Проверьте содержимое APK:
   ```bash
   unzip build/app/outputs/apk/release/app-release.apk -d apk_content
   ls apk_content/lib/
   ```

> **Результат:** В папке `lib` должны быть подпапки для ARM64 и x86_64. Это означает, что APK поддерживает эти архитектуры.

---

## **Контрольные вопросы по теме**

1. **Что такое архитектура процессора? Приведите примеры.**
   - Ответ: Архитектура — набор команд и структуры, которые определяют работу процессора. Примеры: ARM, x86.

2. **Какие архитектуры поддерживает Flutter для Android?**
   - Ответ: ARMv7 (32-бит), ARM64 (64-бит), x86_64 (для эмуляторов), MIPS (устаревшая).

3. **Как указать поддерживаемые архитектуры при сборке APK в Flutter?**
   - Ответ: Через настройку `abiFilters` в файле `android/app/build.gradle`.

4. **Почему важно учитывать архитектуру процессора при разработке Flutter-приложений?**
   - Ответ: Неверно указанные архитектуры могут привести к ошибкам на устройствах, несовместимых с кодом.

5. **Как проверить, какие архитектуры поддерживаются в собранном APK?**
   - Ответ: Распакуйте APK и проверьте содержимое папки `lib/`.

---

## **Список литературы и ссылок для дополнительного чтения**

1. [Официальная документация Flutter: Поддержка Android](https://docs.flutter.dev/platform-integration/android)
2. [Android NDK: ABI Filters](https://developer.android.com/studio/build/configure-gradle-builds#ndk_abi_filters)
3. **Книга:** *Flutter in Action* — Дэвид Хармс, Майкл Пенроуз (раздел о сборке и поддержке архитектур).
4. [Статья: Understanding Flutter and Android ABIs](https://medium.com/@lajosbencz/understanding-flutter-and-android-abis-d50172f86c3a)
5. **GitHub:** [Flutter example with ABI support](https://github.com/flutter/flutter/tree/main/examples/hello_world)

---

## **Дополнительные рекомендации**
- Используйте флаг `--split-per-abi` для создания отдельных APK для каждой архитектуры (улучшает загрузку на устройства).
- Для iOS используйте только ARM64, так как Apple не поддерживает x86_64 в реальных устройствах.
- Проверяйте обновления Flutter SDK — новая версия может добавить поддержку новых архитектур.

---

**Заключение:**  
Понимание архитектуры процессора и настройка поддержки нужных ABI (Application Binary Interface) в Flutter-приложениях позволяет создавать приложения, которые корректно работают на всех устройствах. Это особенно важно для мобильной разработки, где архитектура устройства влияет на производительность и совместимость.