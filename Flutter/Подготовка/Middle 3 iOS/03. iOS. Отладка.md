# Лекция: **iOS-разработка. Отладка приложений на Swift**

---

## Введение
Отладка — это процесс выявления и устранения ошибок в программе. На этапе разработки мобильных приложений она играет ключевую роль, особенно для Middle-разработчиков, которые сталкиваются с сложными сценариями: асинхронные операции, непредсказуемые поведения UI, баги в производительности. В Swift и Xcode есть мощный инструмент — **LLDB**, который позволяет устанавливать точки останова (breakpoints), выполнять команды по отладке, анализировать состояние программы в реальном времени. Эта лекция будет полностью посвящена техникам отладки, которые позволят эффективно находить и исправлять ошибки.

---

## 1. Настройка break points (точек останова)

### Определение
Breakpoint — это точка в коде, где выполнение программы приостанавливается для анализа состояния переменных, вызовов функций и потока исполнения. Xcode поддерживает разные типы точек останова:

---

### **1.1 Стандартный breakpoint**
**Описание**: Самый простой способ — установить точку останова в любом месте кода (например, в теле функции, цикла или перед вызовом метода). При достижении этой точки выполнение приостанавливается, и отладчик позволяет исследовать состояние программы.

**Как создать**:
1. Откройте файл Swift-кода в Xcode.
2. Кликните по строке кода, где хотите установить breakpoint (например, `func someFunction()`).
3. Появится красная точка — это breakpoint (или можно использовать горячую клавишу **Command + Option + B**).

**Пример:**
```swift
func calculateSum(a: Int, b: Int) -> Int {
    let result = a + b  // Установим breakpoint здесь
    return result
}
```

**Использование**:
- Когда вы запустите приложение в режиме отладки (Debug), выполнение остановится на этой строке.
- В правой части Xcode отобразятся значения переменных `a`, `b`, и `result` в панели **Variables View**.

---

### **1.2 Условные breakpoints**
**Описание**: Точка останова активируется только тогда, когда выполнено определённое условие (например, значение переменной равно 0 или `error != nil`).

**Как создать**:
1. Щелкните правой кнопкой мыши на существующем breakpoint.
2. Выберите **Edit Breakpoint**, затем перейдите в раздел **Condition**.
3. Введите условие, например: `$a == 0` (если переменная `a` — это аргумент функции).

**Пример:**
```swift
func processData(data: [Int]) {
    for i in 0..<data.count {
        let value = data[i]
        if value > 10 {
            // Установим условный breakpoint здесь, если value > 10
        }
    }
}
```

**Применение**: Помогает избежать останова при каждом вызове функции, что экономит время при отладке.

---

### **1.3 Symbolic breakpoints**
**Описание**: Точки останова, которые срабатывают на уровне вызова определённого метода (например, `objc_exception_throw`). Это полезно для ловли исключений в Objective-C коде или анализа поведения библиотек.

**Как создать**:
1. В Xcode откройте панель **Breakpoint Navigator** (**Command + 8**).
2. Нажмите кнопку **+** и выберите **Symbolic Breakpoint**.
3. В поле **Symbol** введите имя метода (например, `objc_exception_throw`).

**Пример**: Если в приложении вызывается непредвиденное исключение из библиотеки Objective-C, точка останова сработает, и вы сможете увидеть стек вызовов.

---

### **1.4 Exception breakpoints**
**Описание**: Точка останова, которая активируется при возникновении необработанного исключения (например, `fatalError()` или падение из-за некорректного использования API).

**Как создать**:
1. В Xcode откройте **Breakpoint Navigator**.
2. Нажмите **+**, выберите **Add Exception Breakpoint**.
3. Установите параметры: тип исключения (All, Swift, Objective-C) и действия.

**Пример**: Если в коде вызывается `fatalError("Invalid state")`, приложение остановится на этом месте, и вы увидите стек вызовов, где произошёл сбой.

---

## 2. Выполнение команд `p` и `po` в LLDB

### Определение
LLDB — это отладчик Xcode, который предоставляет мощный набор команд для анализа состояния программы. Две наиболее часто используемые команды:

- **`p <expression>`** — выводит значение выражения (например, `p a`).
- **`po <expression>`** — выводит значение выражения как объект (полезно для Objective-C и Swift-объектов с открытыми свойствами).

---

### **2.1 Использование команды `p`**
**Описание**: Эта команда используется для вывода значения любой переменной, включая примитивные типы (Int, String), массивы, словари.

**Пример:**
```swift
var x = 42
var y = "Hello"
```

В консоли LLDB:
```bash
(lldb) p x
(int) $R0 = 42
(lldb) p y
(String) $R1 = "Hello"
```

**Применение**: Помогает проверить значения переменных, которые не отображаются в интерфейсе Xcode (например, локальные переменные внутри функции).

---

### **2.2 Использование команды `po`**
**Описание**: Команда `po` выводит значение выражения как объект. Это особенно полезно для Swift-объектов, которые реализуют протокол `CustomStringConvertible`, или Objective-C-классов.

**Пример:**
```swift
class User {
    var name: String
    init(name: String) { self.name = name }
}
var user = User(name: "Alice")
```

В консоли LLDB:
```bash
(lldb) po user
<User: 0x600003482e00>
```

**Дополнительная информация**: Если класс реализует `description`, можно увидеть более подробные данные:
```swift
extension User: CustomStringConvertible {
    var description: String { return "Name: $name" }
}
```
Результат:
```bash
(lldb) po user
Name: Alice
```

**Применение**: Помогает анализировать сложные объекты, например, массивы с ошибками или объекты из сторонних библиотек.

---

## 3. Сценарии использования отладки

### **Сценарий 1: Исследование состояния переменных в цикле**
```swift
func findMax(numbers: [Int]) -> Int? {
    var max = numbers[0]
    for number in numbers {
        if number > max { // Установить breakpoint здесь
            max = number
        }
    }
    return max
}
```

**Шаги**:
1. Установите breakpoint в строке `if number > max`.
2. Запустите приложение, передав массив `[3, 5, 1, 8]` через отладку.
3. В консоли LLDB выполните команду:  
   ```bash
   (lldb) p number
   ```
   Результат: `number = 5`, затем `8`.

---

### **Сценарий 2: Анализ исключения**
```swift
func divide(a: Int, b: Int) -> Int {
    return a / b // Если b == 0, вызовет исключение
}
```

**Шаги**:
1. Установите Exception breakpoint.
2. Вызовите `divide(a: 10, b: 0)` через отладку (например, в `viewDidLoad()`).
3. Приложение остановится, и вы увидите стек вызовов.

---

## Практическое задание

### Задача:
Реализуйте функцию для сортировки массива студентов по среднему баллу. В коде предусмотрены ошибки: 
```swift
struct Student {
    var name: String
    var grades: [Double]
}

func sortStudents(students: [Student]) -> [Student] {
    return students.sorted { (a, b) in
        let avgA = a.grades.reduce(0, +) / Double(a.grades.count)
        let avgB = b.grades.reduce(0, +) / Double(b.grades.count)
        return avgA > avgB // Ошибочный порядок сортировки
    }
}
```

### Задания:
1. Установите breakpoint в функции `sortStudents()` на строке `return avgA > avgB`.
2. Создайте массив студентов с различными средними баллами.
3. При запуске приложения используйте LLDB, чтобы проверить значения `avgA` и `avgB` через команды `p` и `po`.
4. Исправьте ошибку в логике сортировки (порядок должен быть от большего к меньшему).

---

## Контрольные вопросы

1. Какие типы breakpoints существуют в Xcode, и где их удобнее использовать?
2. Что делает команда `p` в LLDB? Приведите пример использования.
3. В чём разница между командами `p` и `po`? Почему `po` полезна для отладки объектов Swift?
4. Как установить точку останова на уровне вызова метода Objective-C (например, `objc_exception_throw`)?
5. Может ли breakpoint быть условным? Приведите пример.

---

## Список литературы и ссылок

1. [Официальная документация Apple: LLDB](https://developer.apple.com/library/archive/documentation/DeveloperTools/Conceptual/lldb-guide/)
2. [Swift-отладка в Xcode (Hacking with Swift)](https://www.hackingwithswift.com)
3. **Книга**: "Pro iOS Development" — Кэри Хан и Джош Холл, глава 6: "Debugging and Testing"
4. [Ray Wenderlich: Advanced Debugging in Xcode](https://www.raywenderlich.com/5793-advanced-debugging-in-xcode)
5. **Книга**: "iOS Programming: The Big Nerd Ranch Guide" — Глава 12, раздел "Debugging"

---

## Заключение

Отладка — это навык, который требует практики и понимания инструментов Xcode. На уровне Middle-разработчика важно не только уметь находить ошибки, но и оптимизировать процесс отладки с помощью точек останова и LLDB. Умение работать с `p`/`po`, анализировать стек вызовов и использовать условные точки останова — основа эффективного решения проблем в разработке iOS-приложений.