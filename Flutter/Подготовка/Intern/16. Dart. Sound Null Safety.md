# Лекция: Dart. Sound Null Safety

## Введение
Sound Null Safety — это ключевая фича языка Dart, которая позволяет разработчикам избегать ошибок, связанных с `null` значениями. Она была введена в Dart 2.12 и стала частью стандартной практики написания кода на Flutter. Sound Null Safety делает код более надёжным, уменьшая количество runtime-ошибок (таких как `NullPointerException`) и позволяя компилятору проверять корректность использования переменных ещё на этапе написания кода.

### Почему это важно?
При работе с мобильными приложениями Flutter часто возникают ситуации, когда переменная может быть неинициализированной или содержать `null`, если её значение зависит от асинхронных операций (например, загрузка данных из API). Без Sound Null Safety разработчик рискует столкнуться с крашами приложения в момент выполнения кода. Sound Null Safety помогает:

- Избежать ошибок `null` на этапе компиляции.
- Упростить читаемость и поддерживаемость кода.
- Снизить количество тестов, необходимых для проверки корректной обработки `null`.

---

## 1. Nullable типы

### Что такое nullable типы?
Начиная с Dart 2.12, по умолчанию переменные **не могут** принимать значение `null`. Это означает, что если вы объявляете переменную как `String name`, она должна быть инициализирована строковым значением сразу после создания.

Однако в некоторых случаях требуется разрешить присвоение `null` значения. Для этого используются **nullable типы** — это типы, которые могут принимать значение `null`. Обозначаются они с помощью символа вопроса (`?`) после названия типа:

```dart
String? nullableName; // Можно быть null или строкой
```

### Пример использования nullable типов

```dart
void main() {
  String? nullableName = null;
  print(nullableName); // Выведет: null

  nullableName = 'Имя';
  print(nullableName); // Выведет: Имя

  // Попытка присвоить null переменной без ? вызовет ошибку
  String nonNullableName; 
  nonNullableName = null; // Ошибка компиляции: Не может быть присвоен null
}
```

### Когда использовать nullable типы?
- Когда значение переменной может отсутствовать (например, данные из API могут вернуть `null`).
- Когда требуется временно сохранить `null`, чтобы позже обновить его.
- В асинхронных операциях перед тем, как загрузка данных будет завершена.

---

## 2. Проверка на null

### Оператор `??`

Оператор `??` (косвенное присвоение) позволяет указать **значение по умолчанию**, если переменная имеет значение `null`. Это полезно, когда нужно избежать ошибок при обращении к ней в коде.

#### Пример:

```dart
void main() {
  String? name = null;
  String fullName = name ?? 'Гость'; // fullName будет 'Гость'
  print(fullName);

  String username = name ?? 'defaultUser';
  print(username); // Выведет: defaultUser
}
```

### Оператор `?.`

Оператор `?.` позволяет **безопасно вызывать методы или свойства объекта**, если он может быть `null`. Если переменная равна `null`, выражение возвращается как `null`, а не выдаёт ошибку.

#### Пример:

```dart
void main() {
  String? name = null;
  int length = name?.length ?? 0; // length будет 0, потому что name == null
  print(length);

  name = 'Привет';
  length = name?.length ?? 0; // length будет 6
  print(length);
}
```

### Метод `assert` и проверка на null

Также можно использовать `assert`, чтобы убедиться, что переменная не равна `null`. Это особенно полезно в коде, где ожидается определённое значение:

```dart
void main() {
  String? name = 'John';
  assert(name != null); // Успех

  name = null;
  assert(name != null); // Ошибка компиляции: Выражение не может быть null
}
```

---

## 3. Модификатор `late` и ленивая инициализация

### Что такое `late`?

Модификатор `late` позволяет объявить переменную **без её инициализации на этапе объявления**, но с гарантией, что она будет инициализирована позже — до первого использования. Это полезно для:

- Переменных, которые зависят от асинхронных операций.
- Переменных, которые инициализируются в конструкторе или методах.

### Примеры использования `late`

```dart
class User {
  late String name;

  User({required this.name});
}
```

В этом случае переменная `name` будет инициализирована только после создания экземпляра класса. Если не использовать `late`, это вызовет ошибку компиляции:

```dart
class User {
  String name; // Ошибка: name не может быть null

  User({required this.name});
}
```

### Когда использовать `late`?

- Когда переменная инициализируется в конструкторе или позже (например, после асинхронной загрузки данных).
- В случаях, когда инициализация требует времени, но значение необходимо для выполнения кода.
- При работе с зависимостями, которые не могут быть сразу инициализированы.

#### Пример: Асинхронная загрузка данных

```dart
class DataLoader {
  late Future<String> data;

  void load() async {
    data = await fetchFromAPI(); // Инициализация происходит позже
  }
}
```

---

## Практическое задание

### Задача: Написать код с использованием Sound Null Safety и `late`

**Задачи:**
1. Создайте класс `User` с nullable полем `email`.
2. Реализуйте метод, который проверяет, не равно ли `email` `null`, используя операторы `??` и `?`.
3. Используйте `late` для переменной `token`, которая будет инициализирована в асинхронном методе.

#### Решение:

```dart
class User {
  String? email; // Nullable поле

  User({this.email});

  void printEmail() {
    String safeEmail = email ?? 'Нет электронной почты'; // Использование ??
    print(safeEmail);

    int length = email?.length ?? 0; // Использование ? и ??
    print('Длина: $length');
  }
}

class AuthManager {
  late String token;

  Future<void> fetchToken() async {
    await Future.delayed(Duration(seconds: 1)); // Симуляция асинхронной загрузки
    token = 'some_token_here'; // Инициализация позже
  }
}

void main() {
  User user = User(email: null);
  user.printEmail();

  AuthManager auth = AuthManager();
  auth.fetchToken().then((_) => print('Токен: ${auth.token}'));
}
```

---

## Контрольные вопросы

1. Что такое nullable типы в Dart? Приведите пример.
2. Какой символ используется для обозначения nullable типов?
3. В чём разница между операторами `??` и `?.`?
4. Что делает модификатор `late`, и когда его использовать?
5. Какие ошибки могут возникнуть, если не использовать Sound Null Safety в Flutter приложении?
6. Может ли переменная с типом `String?` содержать значение `null`?
7. Какой оператор используется для предоставления значения по умолчанию, если переменная равна `null`?
8. Как можно проверить, что переменная не равна `null`, используя `assert`?

---

## Список литературы и ссылки

1. **Официальная документация Dart: [Null Safety](https://dart.dev/null-safety)**
   - Описание Sound Null Safety, примеры, типы nullable и модификатор `late`.

2. **Книга "Flutter in Action" (Second Edition), by Tarek Sherif & Alok Menghrajani**
   - Раздел о Dart: работа с null безопасностью в Flutter.

3. **Статья: [Dart Null Safety Guide](https://medium.com/@tayyab_ka/dart-null-safety-guide-9df546a102f8)**
   - Подробное объяснение nullable типов, операторов и `late`.

4. **Flutter DevTools: [Null Safety Checker](https://flutter.dev/docs/testing/null-safety-checker)**
   - Инструмент для проверки корректности использования null в коде Flutter.

5. **YouTube-канал "Dart and Flutter" (Серия: Null Safety in Dart 2.12)**

---

## Заключение
Sound Null Safety — это фундаментальный элемент современного разработчика на Dart и Flutter. Умение использовать nullable типы, операторы `??` и `?.`, а также модификатор `late` позволяет писать более надёжный, читаемый и безопасный код. Регулярная практика с заданиями и изучение официальной документации поможет вам достичь профессионального уровня в разработке мобильных приложений на Flutter.